---
title: "full_life_tablea"
output:
  pdf_document: default
  html_document: default
---

```{r tidyverse, message=FALSE, warning=FALSE, echo=FALSE}
if(! 'pacman' %in% installed.packages()[,1]){
  install.packages("pacman")
}

pacman::p_load(tidyverse)
pacman::p_load(plotly)
pacman::p_load(foreach)
pacman::p_load(iterators)
pacman::p_load(DT)
pacman::p_load(ade4)
pacman::p_load(FactoMineR)
pacman::p_load(factoextra)
pacman::p_load(FactoInvestigate)
pacman::p_load(ggfortify)
pacman::p_load(pathlibr)
pacman::p_load(demography)
pacman::p_load(glue)
```

```{r, include=FALSE}
fpath <- 'full_life_table.Rds'  # once you have downloaded the file

if (! file.exists(fpath)){
  cat(glue('{fpath} should be in working directory!'))
} else {
  life_table <- readr::read_rds(fpath)
  glimpse(life_table)
}
```


```{r}
knitr::kable(head(life_table))
```
```{r}
levels(as.factor(life_table$Gender))
```
##PLOT Qx Year 1948, Age, filter by Countries
```{r}
life_table48 <- life_table %>% filter( Year==1948) %>% #J'ai rajouter '<- life_table' parce que y'avais pas de référence sur mon IDE
  ggplot() +
  geom_point(mapping = aes(y= qx, x= Age,col= Country),alpha=0.35) #+  scale_y_continuous(trans='log10') #si tu veux l'échelle log

# Si on prend l'échelle log pour les qx, faut regler le problème des warnings.. à priori on a besoin de plot sur l'échelle log. -CG
# Mettre un titre ? -CG
life_table48 #Si tu veux l'afficher -CG

```

###COMMENTER

Pour l'année 1948, le taux de mortalité est globalement le même pour tout les pays considérés. La mortalité infantile est non négligeable, répartie entre 8% pour l'Espagne à environ 2% en Suède, mais passé les deux premières années de vie, il est très peu probable de mourir jeune. Avant 45 ans, le risque pour tout les pays est inférieur à 1%. Cependant, passé cet âge, le taux de mortalité va commencer à croître de manière importante atteignant 10% vers 75 ans, pour être supérieur à 40% pour les plus de 105 ans, pour l'ensemble des pays.

##PLOT EU/USA Qx ratio, Year 1948, Age, filter by Countries
```{r}

life_table48EUUSA <- life_table %>% filter(Year==1948, Country!="USA") %>%
  ggplot() +
  geom_point(mapping = aes(y= qx/filter(life_table, Year== 1948, Country=="USA")$qx , x= Age ,col= Country), alpha = 0.35) +
  labs(y = "Eu Country/USA Qx Ratio") +
  geom_hline(yintercept = 1)

#J'ai corrigé cette partie, y'avais des erreurs de code pour plot correctement. -CG
#VERIFIE QUE MA FORMULE Y EST CORRECTE, APRIORI LE GRAPHE A DU SENS -CG
life_table48EUUSA  #Si tu veux plot -CG
```

###COMMENTER

La mortalité chez les nouveaux nés jusqu'aux trentenaires est beaucoup plus élevée en Europe qu'aux Etats-Unis, en particulier en Italie et en Espagne et dans une certaine mesure en France. Cependant, ce ratio converge assez rapidement vers 1 quand l'Age augmente. Un sursaut est remarquable entre 20-30 ans, mais passé la trentaine, le ratio semble se stabiliser vers 1, D'abord inférieur à 1 de 30 à 80 ans, il est quasiment égal à 1 (légèrement au dessous ou au dessus) à partir des 90 ans, pour l'ensemble des pays d'Europe considérés.
Le taux de mortalité chez les jeunes aux Etats-Unis est donc plus faible qu'en Europe, mais il tend à être égal avec les autres pays quand les gens vieillissent.



#5 Death Rate Evoution since WWII

##PLOTS AND FACET
```{r}
life_tablePer10 <- life_table %>% filter(Gender!="Both", Year %in% seq(1946,2016,by=10))  %>%
   ggplot() +
   geom_point(mapping = aes(x = Age, y = qx, col = as.factor(Year)), alpha = 0.35)

life_tablePer10Wrap <- life_tablePer10 + facet_wrap(Country ~ Gender)
#On les affiche
life_tablePer10
life_tablePer10Wrap
```

##Ratio_Mortality
```{r}
ratio_mortality_rates <- function(df,
                                  reference_year=1946,
                                  target_years=seq(1946, 2016, 10)){
  df1 = df %>%
    filter(Year %in% target_years) %>%
    group_by(Country, Year, Age, Gender) %>%
    select(Year, Age , qx , Country , Gender) 
  
  df2 = df %>%
    filter(Year == reference_year) %>%
    group_by(Country, Year, Age, Gender) %>%
    rename(qx.ref_year = qx )
  
  
  return(select(inner_join(df1,df2, by= c("Age", "Gender", "Country")), Year.x, Age, qx, qx.ref_year, Country, Gender))
}

rm_Table <- ratio_mortality_rates(life_table, reference_year = 1946 , target_years = seq(1946,2016,10))

#On l'affiche 
rm_Table
```
##PLOT Ratio_Mortality

```{r}
rm_TablePerRef <- rm_Table %>% filter(Gender!="Both", Year.x %in% seq(1956,2016,by=10))  %>%
   ggplot() +
   geom_point(mapping = aes(x = Age, y = qx/qx.ref_year, col = as.factor(Year.x), shape = Gender), alpha = 0.35)

rm_TablePerRef10Wrap <- rm_TablePerRef + facet_wrap(Country ~ Gender)
#On les affiche
rm_TablePerRef
rm_TablePerRef10Wrap
```
##COMMENTER

Avec ces graphiques, on remarque qu'il est beaucoup moins probable de mourir en bas âge qu'en 1946 avec le ratio inférieur à 1 pour tout les pays. En grandissant, ce risque décroit fortement au fûr et à mesure des décennies, et ceux pour tout les pays : Le ratio est d'environ 0.35 à 60 ans en moyenne sur les pays en 2016, il était à environ 0.55 en 1996 et d'environ 0.8 en 1956. 


A VOIR SI ON PEUT AMELIORER - CG


#6 Trends 


##PLOT ET COMMENT
```{r}
life_table %>%
  filter(Age %in% c(0,1,5), Gender != "Both") %>%
  ggplot(mapping = aes (x = Year , y=qx , col = as.factor(Age))) +
  geom_line()+
  facet_grid(Country~Gender, scales = 'free')
```
IL FAUT COMMENTER -CG LA PREMIERE ANNEE AVAIT DE HAUT RISQUE DE DECEDER PARTICULIEREMENT ELEVE EN EUROPE, CA SE NULLIFIE A PARTIR DES ANNEES APRES LA DEUXIEME GUERRE MONDIALE.

##PLOT ET COMMENT
```{r}
life_table %>%
  filter(Age %in% c(15,20,40,60)) %>% #Exclure Gender Both ?
  ggplot(mapping = aes (x = Year , y=qx , col =as.factor(Age))) +
  geom_line()+
  facet_grid(Country~Gender, scales = 'free')

```
IL FAUT COMMENTER -CG /!\ REMARQUER CHEZ LES HOMMES LES PICS AVEC LES GUERRES MONDIALES POUR ANGLETERRE, FRANCE ET ITALIE/!\

#7 Rearrangement 
```{r}
pivot_life <- function(life_table) {
life_table_pivot <- life_table %>%
  select(Country, Gender, Year, Age, qx) %>%
    pivot_wider(
      id_cols = c("Country","Gender","Year"),
      names_from = Age,
      values_from = qx
    )
return (life_table_pivot)
}

life_table_pivot <-pivot_life(life_table)
  
```


Calcul de l'esperance d vie d'une population selon une anné&e A;

```{r}
fun <- function(x) {return(1-identity(x))}

life_exp <- life_table_pivot %>%
  select (-Gender, -Year , -Country) %>%
  apply(MARGIN = 1, FUN = fun)%>%
  t() %>%
  apply ( MARGIN = 1 , cumprod) %>%
  t() %>%
  apply(MARGIN =  1, sum) %>%
  cbind(life_table_pivot)


names (life_exp )[1] <- "e0x" 
life_exp[1] <- life_exp[1] + 0.5

life_exp <- life_exp[,-c(5:114)]
life_exp %>%
  glimpse()


```
#8 LIFE EXPECTANCY
```{r}
ex_res <- function(v_qx, age) {
  if (age > 0) {
    residual_ex <- (fun(v_qx[,-c(1:age)]))
  } else {
    residual_ex <- fun(v_qx)
    }
residual_ex <- residual_ex %>%
  apply(MARGIN = 1, cumprod) %>%
  t() %>%
  apply(MARGIN =  1, sum) + 0.5

return(residual_ex) #A VERIFIER AVEC SKAAN ET LUCAS
}

ex_res(life_table_pivot[1,4:113], 0)
ex_res(life_table_pivot[1,4:113], 1)
ex_res(life_table_pivot[1,4:113], 70)
```
#8 RES LIFE EXPECTANCY TABLE
```{r}
ex_res_table <- function(df) {
  tri <- df
  p <- pivot_life(tri)
  res_lex = c()
  for(i in c(1:nrow(p))) {
    for(j in c(0:109)) {
      res_lex <- append(res_lex, ex_res(p[i,4:113], j))
    }
  }
  exp_res_life_table <- tri[c(1,2,11,12)] %>% cbind(res_lex)
  return(exp_res_life_table) 
}

Residual_Exp_life_table <- readr::read_rds("Residual_Exp_life_table.rds")

#ALGORITHME TRES GOURMAND EN RESSOURCES A FAIRE TOURNER CHEZ MOI
```





# Regarder la periode de la  peste 1720

# 1832 / 1850 a pairs cholera (1832)

# 1870 / 1860 guerre ext et guerre civile => toucvhe homme et femme 

#PCA et svd 
#T T // F F // T F // F T à faire !!!!!!!!!!!


```{r}

library(ggplot2)
fr_pca_f <- life_table_pivot %>%
  filter(Country =='France' , Gender == 'Female' , Year %in% 1948:2010)
fr_pca_f[,4:113] = log(fr_pca_f[,4:113])

#Acp avec centrage et normalisation 

resultsTT <- prcomp(fr_pca_f[, 3:113] , scale. = TRUE ,center = TRUE)


#Acp sans centrage et normalisation 
resultsFF <- prcomp(fr_pca_f[, 3:113] , scale. = FALSE ,center = FALSE)

resultsTF <- prcomp(fr_pca_f[, 3:113] , scale. = TRUE ,center = FALSE)
resultsFT <- prcomp(fr_pca_f[, 3:113] , scale. = FALSE ,center = TRUE)



#reverse the signs
resultsFF$rotation <- -1 * resultsFF$rotation
resultsTT$rotation <- -1 * resultsTT$rotation
resultsTF$rotation <- -1 * resultsTF$rotation
resultsFT$rotation <- -1 * resultsFT$rotation




#display principal components
resultsFF$rotation %>%
  head(sample= n(4))

resultsTT$rotation %>%
  head(sample= n(4))
resultsTF$rotation %>%
  head(sample= n(4))
resultsFT$rotation %>%
  head(sample= n(4))


#reverse the signs of the scores
resultsTT$x <- -1*resultsTT$x
resultsFF$x <- -1*resultsFF$x
resultsTF$x <- -1*resultsTF$x
resultsFT$x <- -1*resultsFT$x


#display the first six scores
head(resultsTT$x)
head(resultsFF$x)
head(resultsTF$x)
head(resultsFT$x)


summary(resultsTT)
summary(resultsFF)
summary(resultsTF)
summary(resultsFT)


#commenter tous les graphiques 





#rajouter le screplot ! 

s1 <- fviz_eig(resultsTT)
s2 <- fviz_eig(resultsFF)
s3 <- fviz_eig(resultsTF)
s4 <- fviz_eig(resultsFT)

gridExtra::grid.arrange(s1,s2,s3,s4,ncol=2,nrow=2)

ss1 <- fviz_pca_var(resultsTT , col.var = "contrib" , gradient.cols = c("red" , "black" , "yellow") , 
                    repel=TRUE)
ss2 <- fviz_pca_var(resultsFF , col.var = "contrib" , gradient.cols = c("red" , "black" , "yellow") , 
                    repel=TRUE)
ss3 <- fviz_pca_var(resultsTF , col.var = "contrib" , gradient.cols = c("red" , "black" , "yellow") , 
                    repel=TRUE)
ss4 <- fviz_pca_var(resultsFT , col.var = "contrib" , gradient.cols = c("red" , "black" , "yellow") , 
                    repel=TRUE)
gridExtra::grid.arrange(ss1,ss2,ss3,ss4,ncol=2,nrow=2)


f1<-fviz_pca_biplot(resultsTT,repel = TRUE ,col.var = "Grey" ,col.ind = "Blue")
f2<-fviz_pca_biplot(resultsFF,repel = TRUE ,col.var = "Grey" ,col.ind = "Blue")
f3<-fviz_pca_biplot(resultsTF,repel = TRUE ,col.var = "Grey" ,col.ind = "Blue")
f4<-fviz_pca_biplot(resultsFT,repel = TRUE ,col.var = "Grey" ,col.ind = "Blue")

gridExtra::grid.arrange(f1,f2,f3,f4, ncol= 2, nrow = 2)


#motivez choix choix des axes => 

#- regarder la repartition de la variance suivant les cas  -> plot du cours 
#- rendre comparable les variables qui ont des variances differnentes ! 



#tous les pays et tous les sexes 
resultsTT_ALL <-prcomp(life_table_pivot[, 3:113] , scale. = TRUE ,center = TRUE)
resultsTT_ALL$rotation <- -1 *resultsTT_ALL$rotation
resultsTT_ALL$x <- -1 *resultsTT_ALL$x

par (mfrow = c(1,2))
biplot(resultsTT_ALL)
biplot(resultsTT)

# commenter wtf ???



# biplot (differnets pays et sexes )
#a faire !!!!!!
#Combinez les biplots pour différents pays (pour chaque sexe). Commentaire
#groups1 <- c("Male","Female","Both")
#groups2 <- c("France","Spain","Italy","USA","Netherlands","Sweden","UK")
#fviz_pca_biplot(resultsTT_ALL, col.ind = groups1 , col.var = groups2)

```



# Données US

```{r}
library(demography)
library(forecast)
install.packages("lifecontingencies")
library(lifecontingencies)
```


```{r}
# je veux une matrice row = time , col =age 

# preparer pour svd 

uSA <-pivot_life_table %>%
  dplyr::filter(Country == 'USA' , Gender == 'Both')%>%
  dplyr::select(-Country,-Gender)
uSA[,2:111] = log(uSA[,2:111])

svd1 <- svd(uSA ,nv=2)
summary(svd1) %>%
  knitr::kable()

library(reshape2)
#trouver exposition à la mort  en fct de qx ?
#filtrer life table a usa et selectioner uniquement les dx et qx et age et year 
#esssayer d'avoir une matrice de la meme dimensiion que life table pivot fiotre aux USA 

pivot_life_lx <- function(life_table) {
life_table_pivot <- life_table %>%
  select(Country, Gender, Year, Age, lx) %>%
    pivot_wider(
      id_cols = c("Country","Gender","Year"),
      names_from = Age,
      values_from = lx
    )
return (life_table_pivot)
}
library(tidyverse)
l__x <- pivot_life_lx(life_table)
l__x =filter(l__x , Country == 'USA')
l__x %>%
  select(-Gender, -Country)
#zessayer avec lx !
Exp <- life_table$lx

#créer un life table pivot avec lx de mm dim que life_pivot _qx
pop <- acast(l__x,Age~Year,)

USm <- demography::demogdata(data = t(uSA), 
                 pop = t(l__x), 
                 ages = as.integer(rownames(t(uSA))), 
                 years= as.integer(colnames(t(uSA))), 
                 type = "mortality", 
                 label = "USA", 
                 name = "male")


lc()




```

# Lee carter iterative fit 
minimising loss function 
-> fixing one of the parmeters and try to estimate otheerts 
```{r}
library(dplyr)
library(ggplot2)
usa <- life_table %>%
  filter(Country == 'USA', Year %in% 1933:1995)
usa_male <- usa %>%
  filter(Gender == 'Male')%>%
  head()
usa_female <- life_table %>%
  filter(Country == 'USA',Gender == 'Female')%>%
  head()
usa_both <- life_table %>%
  filter(Country == 'USA',Gender == 'Both') %>%
  head()
  
X <- model.matrix(
  ~ as.factor(usa$Age)
  -1
)
dim(X)

y <- log(usa$qx)
# -1 indicates that we would not want to put the general intercept inside of our model


#analytic expr of beta_1 of our model 
alpha_est_expl <- solve(
              crossprod(X)) %*%
                t(X) %*% y #DIY

alpha_est <- lm(
          y ~ -1 +
            as.factor(usa$Age))$coef #i want a specific age intercept and not an overall age intercept thats why i use as.factor
#use lm(.) function
#extract $coef from the fitted
#lm(.) object

#plot the resulting parameter estimate 


plot(alpha_est ) 
title("usa"); xlab = "age" ; ylab = "beta(1)"


library(ggplot2)
data <- tibble(age = 0:109, fit= alpha_est)
g <- ggplot(data) + geom_point(aes(age,alpha_est)) +
  geom_line(aes(age,alpha_est) , col = "black") +
  theme_bw() +
  ggtitle("Usa - filter 1933;1995") +
  labs(y = bquote(hat(beta)[x]^"(1)"))
g

#on initialise le k_t(2) 
#on cree la variable response Z_(x,t)
#n'est pas oublier la dimension de la matrix design X quand on soustrait B_x(1)


Z <- log(usa$qx) - alpha_est[usa$Age - min(usa$Age)+1]

X <- model.matrix(~ as.factor(usa$Year) - 1)

kappa_est_explicite <- solve(crossprod(X)) %*% t(X) %*% Z


kappa_est <- lm(Z ~ -1 + as.factor(usa$Year))$coef

#la on a juste intiialiser le kappa !

start_year = min(usa$Year)
end_year = max(usa$Year)
data <- tibble(year = start_year:end_year, fit = kappa_est)

g <- ggplot(data) + geom_point(aes(year,kappa_est)) +
  geom_line(aes(year,kappa_est), col= "black") +
  theme_bw() +
  ggtitle("usa starting values") +
  labs(y = bquote(hat(kappa)[t]^"(2)"))
g


#maintenant on intialise le b_x(2)

var_kappa <- kappa_est[usa$Year - min(usa$Year) +1] #a numeric variable as the same length as Z

# as.factor(usa$Age):var_kappa => we buiild the interation between this variale and an age-specific intercept

X <- model.matrix( ~ as.factor(usa$Age):var_kappa -1)
beta_est_expl <- solve(crossprod(X)) %*% t(X) %*% Z                            

beta_est <- lm(Z ~ -1 + as.factor(usa$Age):var_kappa)$coef

data <- tibble(age = 0:109 , fit = beta_est)
g <- ggplot(data) + geom_point(aes(age,beta_est)) +
  geom_line(aes(age,beta_est), col= "black") +
  theme_bw() +
  ggtitle("usa starting values") +
  labs(y = bquote(hat(beta)[x]^"(2)"))
g

converged =F
iter = 1 

while(!converged) {
  beta_est_old = beta_est    
  kappa_est_old = kappa_est  
  
  # (2) : estimate kappa's 
  var_beta = beta_est[usa$Age - min(usa$Age) +1]
  X  =  model.matrix(~ as.factor(usa$Year):var_beta -1)
  kappa_est = solve(crossprod(X)) %*% t(X) %*% Z
  
  #(3) : estimate beta's
  var_kappa = kappa_est[usa$Year - min (usa$Year) +1]
  X = model.matrix( ~as.factor(usa$Age):var_kappa -1)
  beta_est  = solve(crossprod(X)) %*% t(X) %*% Z
  
  # stopping criterion
  converged = max(abs(beta_est - beta_est_old) / abs(beta_est_old) , abs(kappa_est - kappa_est_old) / abs(kappa_est_old)) < 1e-8
  iter = iter+ 1
  if (iter %% 1e2 == 0)
    cat("\n\n Iteration number ", iter , "\n\n")
}

#plot the initial estilmates and the parameter estimatees obtained after convergence #together on the same plot !!
data <- tibble(age = 0:109 , fit = beta_est , init = beta_est_expl)
  g <- ggplot(data) + geom_point(aes(age,fit)) +
  geom_line(aes(age,fit), col= "black") +  
  geom_line(aes(age,init), col= "red") +
  theme_bw() +
  ggtitle("usa starting values + final values") +
  labs(y = bquote(hat(beta)[x]^"(2)"))
g


#we need to make sure the paramater estimates satisfy the (usual) set of Lee carter parameter constraints
#thats is sum(k_t) de t>=0 = 0
#sum surx (beta_x) = 1 


beta_est_LS = beta_est / sum(beta_est)
kappa_est_LS = (kappa_est - mean(kappa_est)) * sum(beta_est)
alpha_est_LS = alpha_est + beta_est * mean(kappa_est)

#final check
sum(beta_est_LS)

sum(kappa_est_LS)



#plot beta 1 beta 2 et kappa 2
dim(kappa_est_explicite)
dim(kappa_est)
data_period <- tibble(year = start_year:end_year , fit = kappa_est , init = kappa_est_explicite)
data_age <- tibble(age = 0:109 , fit_alpha = alpha_est , fit_beta = beta_est)

g_1 <- ggplot(data_age) + geom_point(aes(age,fit_alpha)) +
  geom_line(aes(age,fit_alpha), col ="black") +
  theme_bw() +
  ggtitle("usa final estimates") +
  labs(y = bquote(hat(beta)[x]^"(1)"))
g_2 <- ggplot(data_age) + geom_point(aes(age,fit_beta)) +
  geom_line(aes(age,fit_beta), col ="black") +
  theme_bw() +
  ggtitle("") +
  labs(y = bquote(hat(beta)[x]^"(2)"))

g_3 <- ggplot(data_period) + geom_point(aes(year,fit)) +
  geom_line(aes(year,fit), col ="black") +
  theme_bw() +
  ggtitle("") +
  labs(y = bquote(hat(kappa)[t]^"(1)"))
gridExtra::grid.arrange(g_1,g_2,g_3 , ncol=2)

plot(kappa_est)

```



# LEe carter avec SVD
```{r}

Years <- 1933:1995
Age <- 1:110

m<- filter(life_table_pivot , Country == 'USA' ,Gender == 'Both', Year %in% Years) %>%
  select(-Gender,-Country,-Year)
m<- log(m)
n.x = nrow(m) # 63
n.y = ncol(m) # 110

m_mat <- as.matrix(m, nrow = n.y, ncol = n.x) # 110 X 63
plot(m_mat[,1], type = "l") #mortality of all ages in year 1933
# Mean log mortality for all age groups under consideration (Age)
a_age <- colMeans(m_mat)
lines(y = Age, x = a_age, col = 2)#average mortality for all age groups

# plotting mortality for Age = 65 as a trial run to see if code is working
# as exxpected
plot(x = Years, y = m_mat[,65], pch = 18, xlab = "Years", ylab = "log m", col = 2) #working!!!

# Average mortality across each year
a_year <- rowMeans(m_mat)

#We need to estimate parameters ax, bx and kt of the Lee-Carter model
# ax is the avg of log mortality rates over time. ie sum(log m)/n.y
# avg of log rates -> a_hat <- rowSums(m)/94
# Subtracting a from all years in m_mat
m_hat <- matrix(1, nrow = n.x, ncol = n.y) #Dummy matrix with dim 94 X 111
m_hat <- t(m_mat)
m_mat <- t(m_mat)
for(i in 1:n.y) m_hat[,i] <- m_mat[,i] - a_age[i]
m_hat <- m_hat[,1:110]
age_mod <- 1:110
#SVD
svd_ <- svd(m_hat,1,1)
v <- svd_$v
u <- svd_$u
d <- svd_$d

b <- v/sum(v)
k <- u * sum(v) * d[1]
fit_1 = a_age[age_mod] + (b * k[1])
plot(x = age_mod, y = m_mat[1,age_mod], pch = 19, xlab = "Age", ylab = "m")
lines(x = age_mod, y = fit_1, col = 2, lwd = 2, xlab = "Age", ylab = "m")

fit_end <- a_age[age_mod] + (b * k[63])
plot(x = age_mod, y = m_mat[63,age_mod], pch = 18)
lines(x = age_mod, y = fit_end, col = 2, lwd = 2)

#Plotting parameter
par(mfrow = c(2,2))
plot(x = Years, y = k, type = "l")
plot(x = age_mod, y = a[age_mod], type = "l", xlab = "Ages", ylab = "ax")
plot(x = age_mod, y = b[age_mod], type = "l", xlab = "Ages", ylab = "bx" )
#plotting m over "Years"
plot(x = Years, y = m_mat[,1], pch = 19, ylab = "m", xlab = "Years", type = "l")
par(mfrow = c(1,1))

########################################################################################

svdusa <- svd(m,1,1)

svdusa$d == k


```


# rien 
```{r}


usqx <- life_table %>%
  filter(Country == 'USA', Year %in% 1933:1995 ,Gender=='Both') %>%
  select(qx,Year,Age)

rates <- (usqx$qx)

M <- matrix(log(rates), 63, 110 ,byrow = TRUE)

#The first thing we need is the mean log-rate for each age group. This is easily computed using colMeans().

a <- colMeans(M)

for(j in 1:63) M[,j] <- M[,j] - a[j]

d <- svd(M, 1, 1)
b <- d$v/sum(d$v)
k <- d$u * sum(d$v) * d$d[1]


usmx2 <- filter(usqx, Year==1933 | Year == 1987) %>% 
  mutate(year = factor(Year),fit = c(exp(a + b * k[1]), exp(a + b * k[55])))




usmx2<-life_table_pivot %>%
  filter(Country == 'USA' , Gender == 'Both') %>%
  select(-Country,-Gender,-Year)

usmx2 %>%
  glimpse()


```

