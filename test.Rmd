---
title: "full_life_tablea"
output:
  pdf_document: default
  html_document: default
---

```{r tidyverse, message=FALSE, warning=FALSE, echo=FALSE}
if(! 'pacman' %in% installed.packages()[,1]){
  install.packages("pacman")
}

pacman::p_load(tidyverse)
pacman::p_load(plotly)
pacman::p_load(foreach)
pacman::p_load(iterators)
pacman::p_load(DT)
pacman::p_load(ade4)
pacman::p_load(FactoMineR)
pacman::p_load(factoextra)
pacman::p_load(FactoInvestigate)
pacman::p_load(ggfortify)
pacman::p_load(pathlibr)
pacman::p_load(demography)
pacman::p_load(glue)
```

```{r, include=FALSE}
fpath <- 'full_life_table.Rds'  # once you have downloaded the file

if (! file.exists(fpath)){
  cat(glue('{fpath} should be in working directory!'))
} else {
  life_table <- readr::read_rds(fpath)
  glimpse(life_table)
}
```


```{r}
knitr::kable(head(life_table))
```
```{r}
levels(as.factor(life_table$Gender))
```
##PLOT Qx Year 1948, Age, filter by Countries
```{r}
life_table48 <- life_table %>% filter( Year==1948) %>% #J'ai rajouter '<- life_table' parce que y'avais pas de référence sur mon IDE
  ggplot() +
  geom_point(mapping = aes(y= qx, x= Age,col= Country),alpha=0.35) #+  scale_y_continuous(trans='log10') #si tu veux l'échelle log

# Si on prend l'échelle log pour les qx, faut regler le problème des warnings.. à priori on a besoin de plot sur l'échelle log. -CG
# Mettre un titre ? -CG
life_table48 #Si tu veux l'afficher -CG

```

###COMMENTER

Pour l'année 1948, le taux de mortalité est globalement le même pour tout les pays considérés. La mortalité infantile est non négligeable, répartie entre 8% pour l'Espagne à environ 2% en Suède, mais passé les deux premières années de vie, il est très peu probable de mourir jeune. Avant 45 ans, le risque pour tout les pays est inférieur à 1%. Cependant, passé cet âge, le taux de mortalité va commencer à croître de manière importante atteignant 10% vers 75 ans, pour être supérieur à 40% pour les plus de 105 ans, pour l'ensemble des pays.

##PLOT EU/USA Qx ratio, Year 1948, Age, filter by Countries
```{r}

life_table48EUUSA <- life_table %>% filter(Year==1948, Country!="USA") %>%
  ggplot() +
  geom_point(mapping = aes(y= qx/filter(life_table, Year== 1948, Country=="USA")$qx , x= Age ,col= Country), alpha = 0.35) +
  labs(y = "Eu Country/USA Qx Ratio") +
  geom_hline(yintercept = 1)

#J'ai corrigé cette partie, y'avais des erreurs de code pour plot correctement. -CG
#VERIFIE QUE MA FORMULE Y EST CORRECTE, APRIORI LE GRAPHE A DU SENS -CG
life_table48EUUSA  #Si tu veux plot -CG
```

###COMMENTER

La mortalité chez les nouveaux nés jusqu'aux trentenaires est beaucoup plus élevée en Europe qu'aux Etats-Unis, en particulier en Italie et en Espagne et dans une certaine mesure en France. Cependant, ce ratio converge assez rapidement vers 1 quand l'Age augmente. Un sursaut est remarquable entre 20-30 ans, mais passé la trentaine, le ratio semble se stabiliser vers 1, D'abord inférieur à 1 de 30 à 80 ans, il est quasiment égal à 1 (légèrement au dessous ou au dessus) à partir des 90 ans, pour l'ensemble des pays d'Europe considérés.
Le taux de mortalité chez les jeunes aux Etats-Unis est donc plus faible qu'en Europe, mais il tend à être égal avec les autres pays quand les gens vieillissent.



#5 Death Rate Evoution since WWII

##PLOTS AND FACET
```{r}
life_tablePer10 <- life_table %>% filter(Gender!="Both", Year %in% seq(1946,2016,by=10))  %>%
   ggplot() +
   geom_point(mapping = aes(x = Age, y = qx, col = as.factor(Year)), alpha = 0.35)

life_tablePer10Wrap <- life_tablePer10 + facet_wrap(Country ~ Gender)
#On les affiche
life_tablePer10
life_tablePer10Wrap
```

##Ratio_Mortality
```{r}
ratio_mortality_rates <- function(df,
                                  reference_year=1946,
                                  target_years=seq(1946, 2016, 10)){
  df1 = df %>%
    filter(Year %in% target_years) %>%
    group_by(Country, Year, Age, Gender) %>%
    select(Year, Age , qx , Country , Gender) 
  
  df2 = df %>%
    filter(Year == reference_year) %>%
    group_by(Country, Year, Age, Gender) %>%
    rename(qx.ref_year = qx )
  
  
  return(select(inner_join(df1,df2, by= c("Age", "Gender", "Country")), Year.x, Age, qx, qx.ref_year, Country, Gender))
}

rm_Table <- ratio_mortality_rates(life_table, reference_year = 1946 , target_years = seq(1946,2016,10))

#On l'affiche 
rm_Table
```
##PLOT Ratio_Mortality

```{r}
rm_TablePerRef <- rm_Table %>% filter(Gender!="Both", Year.x %in% seq(1956,2016,by=10))  %>%
   ggplot() +
   geom_point(mapping = aes(x = Age, y = qx/qx.ref_year, col = as.factor(Year.x), shape = Gender), alpha = 0.35)

rm_TablePerRef10Wrap <- rm_TablePerRef + facet_wrap(Country ~ Gender)
#On les affiche
rm_TablePerRef
rm_TablePerRef10Wrap
```
##COMMENTER

Avec ces graphiques, on remarque qu'il est beaucoup moins probable de mourir en bas âge qu'en 1946 avec le ratio inférieur à 1 pour tout les pays. En grandissant, ce risque décroit fortement au fûr et à mesure des décennies, et ceux pour tout les pays : Le ratio est d'environ 0.35 à 60 ans en moyenne sur les pays en 2016, il était à environ 0.55 en 1996 et d'environ 0.8 en 1956. 


A VOIR SI ON PEUT AMELIORER - CG


#6 Trends 


##PLOT ET COMMENT
```{r}
life_table %>%
  filter(Age %in% c(0,1,5), Gender != "Both") %>%
  ggplot(mapping = aes (x = Year , y=qx , col = as.factor(Age))) +
  geom_line()+
  facet_grid(Country~Gender, scales = 'free')
```
IL FAUT COMMENTER -CG LA PREMIERE ANNEE AVAIT DE HAUT RISQUE DE DECEDER PARTICULIEREMENT ELEVE EN EUROPE, CA SE NULLIFIE A PARTIR DES ANNEES APRES LA DEUXIEME GUERRE MONDIALE.

##PLOT ET COMMENT
```{r}
life_table %>%
  filter(Age %in% c(15,20,40,60)) %>% #Exclure Gender Both ?
  ggplot(mapping = aes (x = Year , y=qx , col =as.factor(Age))) +
  geom_line()+
  facet_grid(Country~Gender, scales = 'free')

```
IL FAUT COMMENTER -CG /!\ REMARQUER CHEZ LES HOMMES LES PICS AVEC LES GUERRES MONDIALES POUR ANGLETERRE, FRANCE ET ITALIE/!\

#7 Rearrangement 
```{r}
pivot_life <- function(life_table) {
life_table_pivot <- life_table %>%
  select(Country, Gender, Year, Age, qx) %>%
    pivot_wider(
      id_cols = c("Country","Gender","Year"),
      names_from = Age,
      values_from = qx
    )
return (life_table_pivot)
}

life_table_pivot <-pivot_life(life_table)
  
```


Calcul de l'esperance d vie d'une population selon une anné&e A;

```{r}
fun <- function(x) {return(1-identity(x))}

life_exp <- life_table_pivot %>%
  select (-Gender, -Year , -Country) %>%
  apply(MARGIN = 1, FUN = fun)%>%
  t() %>%
  apply ( MARGIN = 1 , cumprod) %>%
  t() %>%
  apply(MARGIN =  1, sum) %>%
  cbind(life_table_pivot)


names (life_exp )[1] <- "e0x" 
life_exp[1] <- life_exp[1] + 0.5

life_exp <- life_exp[,-c(5:114)]
life_exp %>%
  glimpse()


```
#8 LIFE EXPECTANCY
```{r}
ex_res <- function(v_qx, age) {
  if (age > 0) {
    residual_ex <- (fun(v_qx[,-c(1:age)]))
  } else {
    residual_ex <- fun(v_qx)
    }
residual_ex <- residual_ex %>%
  apply(MARGIN = 1, cumprod) %>%
  t() %>%
  apply(MARGIN =  1, sum) + 0.5

return(residual_ex) #A VERIFIER AVEC SKAAN ET LUCAS
}

ex_res(life_table_pivot[1,4:113], 0)
ex_res(life_table_pivot[1,4:113], 1)
ex_res(life_table_pivot[1,4:113], 70)
```
#8 RES LIFE EXPECTANCY TABLE
```{r}
ex_res_table <- function(df) {
  tri <- df
  p <- pivot_life(tri)
  res_lex = c()
  for(i in c(1:nrow(p))) {
    for(j in c(0:109)) {
      res_lex <- append(res_lex, ex_res(p[i,4:113], j))
    }
  }
  exp_res_life_table <- tri[c(1,2,11,12)] %>% cbind(res_lex)
  return(exp_res_life_table) 
}

#ALGORITHME TRES GOURMAND EN RESSOURCES A FAIRE TOURNER CHEZ MOI
```





# Regarder la periode de la  peste 1720

# 1832 / 1850 a pairs cholera (1832)

# 1870 / 1860 guerre ext et guerre civile => toucvhe homme et femme 

#PCA et svd 

```{r}
fr_pca_f <- life_table_pivot %>%
  filter(Country =='France' , Gender == 'Female' , Year %in% 1948:2010)
fr_pca_f[,4:113] = log(fr_pca_f[,4:113])

#Acp avec centrage et normalisation 

results_avec_SN <- prcomp(fr_pca_f[, 3:113] , scale. = TRUE ,center = TRUE)


#Acp sans centrage et normalisation 
results_sans_SN <- prcomp(fr_pca_f[, 3:113] , scale. = FALSE ,center = FALSE)

#reverse the signs
results_avec_SN$rotation <- -1 * results_avec_SN$rotation
results_sans_SN$rotation <- -1 * results_sans_SN$rotation

#display principal components
results_avec_SN$rotation %>%
  head(sample= n(4))

results_sans_SN$rotation %>%
  head(sample= n(4))


#reverse the signs of the scores
results_avec_SN$x <- -1*results_avec_SN$x
results_sans_SN$x <- -1*results_sans_SN$x

#display the first six scores
head(results_avec_SN$x)
head(results_sans_SN$x)


summary(results_avec_SN)
summary(results_sans_SN)







par(mfrow=c(1,2)) 
biplot(results_avec_SN, scale = TRUE)
biplot(results_sans_SN)





#use factoshiny 

res.PCA<-PCA(fr_pca_f,quali.sup=c(1,2),graph=FALSE,scale.unit = T)
res.PCA2<-PCA(fr_pca_f,quali.sup = c(1,2) , graph = FALSE , scale.unit = F)
plot.PCA(res.PCA,choix='var',title="Graphe des variables de l'ACP")
plot.PCA(res.PCA,title="Graphe des individus de l'ACP")


summary(res.PCA2)
summary(res.PCA)
par(mfrow = c(2,2))

plot.PCA(res.PCA,choix='var',title="Graphe des variables de l'ACP")
plot.PCA(res.PCA,title="Graphe des individus de l'ACP")
plot.PCA(res.PCA2,choix='var',title="Graphe des variables de l'ACP")
plot.PCA(res.PCA2,title="Graphe des individus de l'ACP")
```


```{r}
Factoshiny::Factoshiny(life_table_pivot)


res.PCA<-PCA(life_table_pivot,quali.sup=c(1,2),graph=FALSE)
plot.PCA(res.PCA,choix='var',title="Graphe des variables de l'ACP")
plot.PCA(res.PCA,title="Graphe des individus de l'ACP")

summary(res.PCA)

```



# Données US

```{r}
library(demography)
library(forecast)
install.packages("lifecontingencies")
library(lifecontingencies)
```
```{r}
library(tidyverse)
```

```{r}
dplyr::filter(life_table, Country == 'USA' , Year %in% 1933:1995)

life_table%>%
  dplyr::filter(Country=='USA' , Year %in% 1933:1995 ,Gender =='Both') %>%
  mutate(qxlog = log(qx)) %>%
  dplyr::select(Year,Age,Country,qx)


USAdemo<-hmd.mx(country="USA", username="skanitoombk@gmail.com",
password="1638011058", label="USA")

italyDemo


par(mfrow=c(1,3))
plot(USAdemo,series="male",datatype="rate", main="Male rates")
plot(USAdemo,series="female",datatype="rate", main="Female rates")
plot(USAdemo,"total",datatype="rate", main="Total rates")



italyLcaM<-lca(USAdemo,series="male",max.age=100)
italyLcaF<-lca(USAdemo,series="female",max.age=100)
italyLcaT<-lca(USAdemo,series="total",max.age=100)



years.fit = 1933 :1995



lca(USAdemo) %>%
  summary()



```

```{r}


library(demography)

USAdata <- hmd.mx(country = "USA" , username = "skanitoombk@gmail.com" , password = "1638011058")
USAdata

plot(USAdata, series = "male")
USAmale <- StMoMoData(USAdata ,series ="male")

years.fit <- 1933:1995
LCfit <- fit(lc() , data = USAmale, years.fit= years.fit)

plot(LCfit)


```
```{r}
# je veux une matrice row = time , col =age 

# preparer pour svd 

uSA <-pivot_life_table %>%
  dplyr::filter(Country == 'USA' , Gender == 'Both')%>%
  dplyr::select(-Country,-Gender)
uSA[,2:111] = log(uSA[,2:111])

svd1 <- svd(uSA ,nv=2)
summary(svd1) %>%
  knitr::kable()

library(reshape2)
#trouver exposition à la mort  en fct de qx ?
#filtrer life table a usa et selectioner uniquement les dx et qx et age et year 
#esssayer d'avoir une matrice de la meme dimensiion que life table pivot fiotre aux USA 



Exp <- 

pop <- acast(Exp,Age~Year,value.var = "Male")

USm <- demogdata(data = t(uSA), 
                 pop = pop, 
                 ages = as.integer(rownames(t(uSA))), 
                 years= as.integer(colnames(t(uSA))), 
                 type = "mortality", 
                 label = "USA", 
                 name = "male")







```

# Lee carter iterative fit 
minimising loss function 
-> fixing one of the parmeters and try to estimate otheerts 
```{r}
library(dplyr)
library(ggplot2)
usa <- life_table %>%
  filter(Country == 'USA')
usa_male <- usa %>%
  filter(Gender == 'Male')%>%
  head()
usa_female <- life_table %>%
  filter(Country == 'USA',Gender == 'Female')%>%
  head()
usa_both <- life_table %>%
  filter(Country == 'USA',Gender == 'Both') %>%
  head()
  
X <- model.matrix(
  ~ as.factor(usa$Age)
  -1
)
dim(X)

y <- log(usa$qx)
# -1 indicates that we would not want to put the general intercept inside of our model


#analytic expr of beta_1 of our model 
alpha_est_expl <- solve(
              crossprod(X)) %*%
                t(X) %*% y #DIY

alpha_est <- lm(
          y ~ -1 +
            as.factor(usa$Age))$coef #i want a specific age intercept and not an overall age intercept thats why i use as.factor
#use lm(.) function
#extract $coef from the fitted
#lm(.) object

#plot the resulting parameter estimate 


plot(alpha_est ) 
title("usa"); xlab = "age" ; ylab = "beta(1)"


library(ggplot2)
data <- tibble(age = 0:109, fit= alpha_est)
g <- ggplot(data) + geom_point(aes(age,alpha_est)) +
  geom_line(aes(age,alpha_est) , col = "black") +
  theme_bw() +
  ggtitle("Usa - filter 1933;1995") +
  labs(y = bquote(hat(beta)[x]^"(1)"))
g

#on initialise le k_t(2) 
#on cree la variable response Z_(x,t)
#n'est pas oublier la dimension de la matrix design X quand on soustrait B_x(1)


Z <- log(usa$qx) - alpha_est[usa$Age - min(usa$Age)+1]

X <- model.matrix(~ as.factor(usa$Year) - 1)

kappa_est_explicite <- solve(crossprod(X)) %*% t(X) %*% Z


kappa_est <- lm(Z ~ -1 + as.factor(usa$Year))$coef

#la on a juste intiialiser le kappa !

start_year = min(usa$Year)
end_year = max(usa$Year)
data <- tibble(year = start_year:end_year, fit = kappa_est)

g <- ggplot(data) + geom_point(aes(year,kappa_est)) +
  geom_line(aes(year,kappa_est), col= "black") +
  theme_bw() +
  ggtitle("usa starting values") +
  labs(y = bquote(hat(kappa)[t]^"(2)"))
g


#maintenant on intialise le b_x(2)

var_kappa <- kappa_est[usa$Year - min(usa$Year) +1] #a numeric variable as the same length as Z

# as.factor(usa$Age):var_kappa => we buiild the interation between this variale and an age-specific intercept

X <- model.matrix( ~ as.factor(usa$Age):var_kappa -1)
beta_est_expl <- solve(crossprod(X)) %*% t(X) %*% Z                            

beta_est <- lm(Z ~ -1 + as.factor(usa$Age):var_kappa)$coef

data <- tibble(age = 0:109 , fit = beta_est)
g <- ggplot(data) + geom_point(aes(age,beta_est)) +
  geom_line(aes(age,beta_est), col= "black") +
  theme_bw() +
  ggtitle("usa starting values") +
  labs(y = bquote(hat(beta)[x]^"(2)"))
g

converged =F
iter = 1 

while(!converged) {
  beta_est_old = beta_est    
  kappa_est_old = kappa_est  
  
  # (2) : estimate kappa's 
  var_beta = beta_est[usa$Age - min(usa$Age) +1]
  X  =  model.matrix(~ as.factor(usa$Year):var_beta -1)
  kappa_est = solve(crossprod(X)) %*% t(X) %*% Z
  
  #(3) : estimate beta's
  var_kappa = kappa_est[usa$Year - min (usa$Year) +1]
  X = model.matrix( ~as.factor(usa$Age):var_kappa -1)
  beta_est  = solve(crossprod(X)) %*% t(X) %*% Z
  
  # stopping criterion
  converged = max(abs(beta_est - beta_est_old) / abs(beta_est_old) , abs(kappa_est - kappa_est_old) / abs(kappa_est_old)) < 1e-8
  iter = iter+ 1
  if (iter %% 1e2 == 0)
    cat("\n\n Iteration number ", iter , "\n\n")
}

#plot the initial estilmates and the parameter estimatees obtained after convergence #together on the same plot !!
data <- tibble(age = 0:109 , fit = beta_est , init = beta_est_expl)
  g <- ggplot(data) + geom_point(aes(age,fit)) +
  geom_line(aes(age,fit), col= "black") +  
  geom_line(aes(age,init), col= "red") +
  theme_bw() +
  ggtitle("usa starting values + final values") +
  labs(y = bquote(hat(beta)[x]^"(2)"))
g


#we need to make sure the paramater estimates satisfy the (usual) set of Lee carter parameter constraints
#thats is sum(k_t) de t>=0 = 0
#sum surx (beta_x) = 1 


beta_est_LS = beta_est / sum(beta_est)
kappa_est_LS = (kappa_est - mean(kappa_est)) * sum(beta_est)
alpha_est_LS = alpha_est + beta_est * mean(kappa_est)

#final check
sum(beta_est_LS)

sum(kappa_est_LS)



#plot beta 1 beta 2 et kappa 2
dim(kappa_est_explicite)
dim(kappa_est)
data_period <- tibble(year = start_year:end_year , fit = kappa_est , init = kappa_est_explicite)
data_age <- tibble(age = 0:109 , fit_alpha = alpha_est , fit_beta = beta_est)

g_1 <- ggplot(data_age) + geom_point(aes(age,fit_alpha)) +
  geom_line(aes(age,fit_alpha), col ="black") +
  theme_bw() +
  ggtitle("usa final estimates") +
  labs(y = bquote(hat(beta)[x]^"(1)"))
g_2 <- ggplot(data_age) + geom_point(aes(age,fit_beta)) +
  geom_line(aes(age,fit_beta), col ="black") +
  theme_bw() +
  ggtitle("") +
  labs(y = bquote(hat(beta)[x]^"(2)"))

g_3 <- ggplot(data_period) + geom_point(aes(year,fit)) +
  geom_line(aes(year,fit), col ="black") +
  theme_bw() +
  ggtitle("") +
  labs(y = bquote(hat(kappa)[t]^"(1)"))
gridExtra::grid.arrange(g_1,g_2,g_3 , ncol=2)

plot(kappa_est)

```


